---
title: Solución ropemporium callme 
date: 2024-01-10
categories: [rop, 64bits, bof]
tags: [64bits, bof, rop] #minúsculas-
---
# callme ropemporium challenge 3

Bueno empezamos con el challenge número 3 de ropemporium que se llama callme voy a resolver el de 64 bits, primero que nada leer las instrucciones.

Nos dice el siguiente:

Failure is not an option
How do you make consecutive calls to a function from your ROP chain that won't crash afterwards? If you keep using the call instructions already present in the binary your chains will eventually fail, especially when exploiting 32 bit binaries. Consider why this might be the case.

Procedure Linkage
The Procedure Linkage Table (PLT) is used to resolve function addresses in imported libraries at runtime, it's worth reading up about it. See Appendix A in the Beginners' guide for a brief explanation of how the PLT is used in lazy binding. Even better, go ahead and step through the lazy linking process in a debugger, it's important you understand what resides at the addresses reported to you by commands like 
```
rabin2 -i <binary> and 
rabin2 -R <binary>
```
You must call the callme_one(), callme_two() and callme_three() functions in that order, each with the arguments 0xdeadbeef, 0xcafebabe, 0xd00df00d e.g. callme_one(0xdeadbeef, 0xcafebabe, 0xd00df00d) to print the flag. For the x86_64 binary double up those values, e.g. callme_one(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d)

The solution here is simple enough, use your knowledge about what resides in the PLT to call the callme_ functions in the above order and with the correct arguments. If you're taking on the MIPS version of this challenge, don't forget about the branch delay slot.

Don't get distracted by the incorrect calls to these functions made in the binary, they're there to ensure these functions get linked. You can also ignore the .dat files and encrypted flag in this challenge, they're there to ensure the functions must be called in the correct order.

Bueno en el enunciado podemos sacar varias conclusiones una que si hacemos de forma contiuada las llamadas a las funciones que queremos fallara, luego nos dice tambien que tenemos que llamar callme_one(), callme_two() and callme_three estas funciones tendremos que passarle argumentos de una longitud determinada.

Abrimos el binario con pwndbg creamos un pattern para calcular el offset con cyclic, como muestro a continuación, luego ejecutamos el binario y le pasamos en el input nuestro pattern esto creara un segmentation fault.
![](/assets/img/rop/callme.png)

Si miramos el valor de la dirección ret podemos ver que está sobrescrita con nuestro pattern copiamos el valor y se lo pasamos a pwndbg de la siguiente forma, de esta forma obtenemos el offset que son 40 bytes.
![](/assets/img/rop/offset2.png)

Tenemos ya la primera pieza para resolver el challenge, vamos a investigar el binario con radare, para eso seguiremos los pasos en la imagen de a continuación.
![](/assets/img/rop/r2callme.png)

En la imagen anterior ejecuto afl para poder ver las funciones veo una que se llama usefulFunction la investigo con pdf, y podemos ver que es un función que hace llamadas a las otras funciones que justamente son las que nos dijo en el enunciado, también si nos fijamos radare nos pone usefulGadgets.

Investigando un poco los gadgets que nos pone, en Wikipedia mismo nos pone en el siguiente apartado:
https://en.wikipedia.org/wiki/X86_calling_conventions#System_V_AMD64_ABI

```
Integer/Pointer Arguments 1-6	RDI, RSI, RDX, RCX, R8, R9
```
Es decir, son registros que nos permiten pasar argumentos, justo lo que queremos poder pasarle argumentos a las funciones que nosotros queremos.

Vamos a hacer un resumen, tenemos el offset de 40 bytes + las direcciones de las funciones + gadgets que nos permiten pasar parámetros a las funciones, en resumen todo lo necesario para construir el POC.

En la web pone también que hay otra forma de solucionarlo y obtener una shell, esto lo dejo para un futuro, ya que dice antes mejor hacer el challenge de pivot.

# Exploit 

![](/assets/img/rop/callmepoc.png)